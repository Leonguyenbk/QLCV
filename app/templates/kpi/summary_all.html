{% extends 'layout/base.html' %}
{% block title %}KPI Chuyên cần — Tổng quan tháng{% endblock %}
{% block content %}
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h3 class="mb-0">KPI Chuyên cần — Tổng quan</h3>
      <span class="text-muted">Tháng {{ "%02d"|format(month) }}/{{ year }}</span>
    </div>

    <div class="d-flex gap-2 align-items-center">
      <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('main.kpi_absence_summary_all', month=prev_month_mm, keyword=keyword, department_id=selected_department) }}" title="Tháng trước">‹</a>

      <!-- ô chọn tháng năm -->
      <input type="month" class="form-control form-control-sm"
             style="width: 150px;"
             value="{{ year }}-{{ '%02d'|format(month) }}"
             onchange="
                if (this.value) {
                  const parts = this.value.split('-');
                  const newFormat = `${parts[1]}-${parts[0]}`;
                  const url = new URL('{{ url_for('main.kpi_absence_summary_all') }}', window.location.origin);
                  url.searchParams.set('month', newFormat);
                  const keyword = '{{ keyword or '' }}';
                  if (keyword) url.searchParams.set('keyword', keyword);
                  const departmentId = '{{ selected_department or '' }}';
                  if (departmentId) url.searchParams.set('department_id', departmentId);
                  window.location.href = url.toString();
                }">

      <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('main.kpi_absence_summary_all', month=next_month_mm, keyword=keyword, department_id=selected_department) }}" title="Tháng sau">›</a>
    </div>
  </div>

  <!-- Form tìm kiếm và lọc -->
  <form method="get" class="row g-3 mb-4 align-items-end bg-light p-3 border rounded">
    <div class="col-md-5">
      <label for="keyword" class="form-label fw-normal">Tìm theo tên nhân viên</label>
      <input type="text" name="keyword" id="keyword" class="form-control form-control-sm" placeholder="Nhập tên để tìm..." value="{{ keyword or '' }}">
    </div>
    <div class="col-md-5">
      <label for="department_id" class="form-label fw-normal">Lọc theo phòng ban</label>
      <select name="department_id" id="department_id" class="form-select form-select-sm">
        <option value="">Tất cả phòng ban</option>
        {% for d in departments %}
        <option value="{{ d.id }}" {% if d.id == selected_department %}selected{% endif %}>{{ d.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-2">
      <button type="submit" class="btn btn-sm btn-primary w-100"><i class="fas fa-filter me-1"></i> Lọc</button>
    </div>
    <input type="hidden" name="month" value="{{ '%02d'|format(month) }}-{{ year }}">
  </form>
  <div class="d-flex justify-content-between align-items-center mt-3">
    <div class="text-muted small">
        Hiển thị <strong>{{ pagination.items|length }}</strong> trong tổng số <strong>{{ pagination.total }}</strong> nhân viên.
    </div>
    {% if pagination.pages > 1 %}
    <nav aria-label="Page navigation">
        <ul class="pagination pagination-sm justify-content-end mb-0">
        <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
            <a class="page-link" href="{{ url_for('main.kpi_absence_summary_all', page=pagination.prev_num, month='%02d-%d'|format(month, year), keyword=keyword, department_id=selected_department) }}">‹</a>
        </li>
        {% for p in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
            {% if p %}
            <li class="page-item {% if p == pagination.page %}active{% endif %}">
                <a class="page-link" href="{{ url_for('main.kpi_absence_summary_all', page=p, month='%02d-%d'|format(month, year), keyword=keyword, department_id=selected_department) }}">{{ p }}</a>
            </li>
            {% else %}
            <li class="page-item disabled"><span class="page-link">…</span></li>
            {% endif %}
        {% endfor %}
        <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
            <a class="page-link" href="{{ url_for('main.kpi_absence_summary_all', page=pagination.next_num, month='%02d-%d'|format(month, year), keyword=keyword, department_id=selected_department) }}">›</a>
        </li>
        </ul>
    </nav>
    {% endif %}
    </div>

  <div class="card border-0 shadow-sm">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-sm table-bordered align-middle">
          <thead class="table-light">
          <tr>
            <th style="width:40px">#</th>
            <th>Nhân viên</th>
            <th class="text-end">Có phép (ngày)</th>
            <th class="text-end">Không phép (ngày)</th>
            <th class="text-end">Tổng (ngày)</th>
            <th class="text-end">Điểm KPI</th>
          </tr>
          </thead>
          <tbody>
          {% if rows %}
            {% for r in rows %}
              <tr class="
                {% if r.kpi_score < 50 %}table-danger
                {% elif r.unpermitted > 0 %}table-warning
                {% endif %}">
                <td>{{ pagination.per_page * (pagination.page - 1) + loop.index }}</td>
                <td><a href="{{ url_for('main.kpi_detail', employee_id=r.employee.id, month=month_str) }}">{{ r.employee.name }}</a></td>
                <td class="text-end">{{ r.permitted }}</td>
                <td class="text-end">{{ r.unpermitted }}</td>
                <td class="text-end fw-semibold">{{ r.total }}</td>
                <td class="text-end fw-bold {% if r.kpi_score >= 85 %}text-success{% elif r.kpi_score >= 70 %}text-info{% elif r.kpi_score >= 50 %}text-warning{% else %}text-danger{% endif %}">
                  {{ '%.1f'|format(r.kpi_score) }}
                </td>
              </tr>
            {% endfor %}
          {% else %}
            <tr><td colspan="6" class="text-center text-muted py-3">Không tìm thấy nhân viên nào khớp với điều kiện.</td></tr>
          {% endif %}
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      
    </div>
  </div>
</div>
{% endblock %}
